<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Database Performance - Admin Panel</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px}
    .container{max-width:1400px;margin:0 auto;background:#fff;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,.1);overflow:hidden}
    .header{background:linear-gradient(135deg,#2c3e50 0%,#34495e 100%);color:#fff;padding:30px;text-align:center}
    .header h1{font-size:2.2rem;margin-bottom:8px}
    .nav-tabs{display:flex;background:#f8f9fa;border-bottom:2px solid #dee2e6}
    .nav-tab{flex:1;padding:14px 18px;text-align:center;background:none;border:none;cursor:pointer;font-size:1.05rem;transition:.2s;border-bottom:3px solid transparent}
    .nav-tab.active{background:#fff;border-bottom-color:#007bff;color:#007bff}
    .nav-tab:hover{background:#e9ecef}
    .tab-content{display:none;padding:28px}
    .tab-content.active{display:block}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:18px;margin-bottom:24px}
    .stat-card{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:22px;border-radius:12px;text-align:center;box-shadow:0 5px 15px rgba(0,0,0,.1)}
    .stat-card .icon{font-size:2rem;margin-bottom:10px}
    .stat-card .value{font-size:1.6rem;font-weight:800;margin-bottom:4px}
    .stat-card .label{font-size:.9rem;opacity:.9}
    .panel{background:#fff;border:1px solid #dee2e6;border-radius:12px;padding:22px;margin-bottom:20px}
    .panel h3{color:#495057;margin-bottom:14px;font-size:1.15rem}
    .kv{display:grid;grid-template-columns:220px 1fr;gap:8px 16px}
    .connection-table{width:100%;border-collapse:collapse;background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 2px 10px rgba(0,0,0,.06)}
    .connection-table th{background:#f8f9fa;padding:14px;text-align:left;font-weight:600;color:#495057;border-bottom:2px solid #dee2e6}
    .connection-table td{padding:12px 14px;border-bottom:1px solid #eee}
    .connection-table tr:hover{background:#fafbfc}
    .alert{padding:14px 16px;border-radius:8px;margin-bottom:16px}
    .alert-info{background:#d1ecf1;color:#0c5460;border-left:4px solid #17a2b8}
    .alert-ok{background:#d4edda;color:#155724;border-left:4px solid #28a745}
    .alert-warn{background:#fff3cd;color:#856404;border-left:4px solid #ffc107}
    .alert-bad{background:#f8d7da;color:#721c24;border-left:4px solid #dc3545}
    .btn{display:inline-block;border:none;border-radius:8px;padding:10px 18px;cursor:pointer;transition:.2s;font-size:1rem;text-decoration:none;color:#fff}
    .btn-refresh{background:linear-gradient(135deg,#28a745,#20c997);margin-right:8px}
    .btn-back{background:linear-gradient(135deg,#6c757d,#495057)}
    .btn:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,.15)}
    .muted{color:#6c757d}
    code{background:#f8f9fa;border:1px solid #e9ecef;border-radius:6px;padding:2px 6px}
    @media (max-width:768px){.kv{grid-template-columns:1fr}}
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1><i class="fas fa-database"></i> Database Performance Monitor</h1>
    <p>SQLite-Statistiken & Health</p>
  </div>

  <div class="nav-tabs">
    <button class="nav-tab active" onclick="showTab(event,'overview')"><i class="fas fa-chart-line"></i> Übersicht</button>
    <button class="nav-tab" onclick="showTab(event,'tables')"><i class="fas fa-table"></i> Tabellen</button>
    <button class="nav-tab" onclick="showTab(event,'pragma')"><i class="fas fa-cogs"></i> PRAGMA</button>
    <button class="nav-tab" onclick="showTab(event,'health')"><i class="fas fa-heartbeat"></i> Health</button>
  </div>

  <!-- Overview -->
  <div id="overview" class="tab-content active">
    <a href="/admin" class="btn btn-back"><i class="fas fa-arrow-left"></i> Zurück zum Admin-Panel</a>
    <button class="btn btn-refresh" onclick="refreshStats()"><i class="fas fa-sync-alt"></i> Aktualisieren</button>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="icon"><i class="fas fa-database"></i></div>
        <div class="value">{{ db_stats.get('sqlite_version','-') }}</div>
        <div class="label">SQLite Version</div>
      </div>
      <div class="stat-card">
        <div class="icon"><i class="fas fa-file"></i></div>
        <div class="value">{{ db_stats.get('db_size_mb','-') }} MB</div>
        <div class="label">Dateigröße</div>
      </div>
      <div class="stat-card">
        <div class="icon"><i class="fas fa-layer-group"></i></div>
        <div class="value">{{ db_stats.get('page_count','-') }}</div>
        <div class="label">Seiten (page_count)</div>
      </div>
      <div class="stat-card">
        <div class="icon"><i class="fas fa-list"></i></div>
        <div class="value">{{ db_stats.get('freelist_count','-') }}</div>
        <div class="label">Freie Seiten</div>
      </div>
    </div>

    <div class="panel">
      <h3><i class="fas fa-info-circle"></i> Datei & Pfad</h3>
      <div class="kv">
        <div class="muted">Datenbankpfad</div>
        <div><code>{{ db_stats.get('database_path','-') }}</code></div>

        <div class="muted">Letzte VACUUM-Info</div>
        <div>{{ db_stats.get('last_vacuum','-') }}</div>

        <div class="muted">Letzte ANALYZE-Info</div>
        <div>{{ db_stats.get('last_analyze','-') }}</div>
      </div>
    </div>
  </div>

  <!-- Tables -->
  <div id="tables" class="tab-content">
    <div class="panel">
      <h3><i class="fas fa-table"></i> Tabellenübersicht</h3>
      {% if db_stats.get('tables') %}
        <table class="connection-table">
          <thead>
          <tr>
            <th>Tabelle</th>
            <th>Zeilen</th>
          </tr>
          </thead>
          <tbody>
          {% for table, count in db_stats.get('tables', {}).items() %}
            <tr>
              <td>{{ table }}</td>
              <td>{{ count if count is not none else '-' }}</td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      {% else %}
        <div class="alert alert-info"><i class="fas fa-info-circle"></i> Keine Tabellenstatistiken verfügbar.</div>
      {% endif %}
    </div>
  </div>

  <!-- PRAGMA -->
  <div id="pragma" class="tab-content">
    <div class="panel">
      <h3><i class="fas fa-tools"></i> PRAGMA Einstellungen</h3>
      <div class="kv">
        <div class="muted">journal_mode</div>
        <div>{{ db_stats.get('journal_mode','-') }}</div>

        <div class="muted">synchronous</div>
        <div>{{ db_stats.get('synchronous','-') }}</div>

        <div class="muted">cache_size</div>
        <div>{{ db_stats.get('cache_size','-') }}</div>

        <div class="muted">foreign_keys</div>
        <div>{{ db_stats.get('foreign_keys','-') }}</div>
      </div>
    </div>
  </div>

  <!-- Health -->
  <div id="health" class="tab-content">
    {% set size = db_stats.get('db_size_mb', 0) %}
    {% if size != 0 and size < 5 %}
      <div class="alert alert-ok"><i class="fas fa-check-circle"></i> Datenbank ist klein und wirkt gesund.</div>
    {% elif size != 0 and size < 50 %}
      <div class="alert alert-info"><i class="fas fa-info-circle"></i> Datenbankgröße ist moderat ({{ size }} MB).</div>
    {% else %}
      <div class="alert alert-warn"><i class="fas fa-exclamation-triangle"></i> Große Datenbank ({{ size }} MB) – regelmäßiges VACUUM/ANALYZE erwägen.</div>
    {% endif %}

    {% set free = db_stats.get('freelist_count', 0) %}
    {% if free and free > 100 %}
      <div class="alert alert-warn"><i class="fas fa-broom"></i> Viele freie Seiten ({{ free }}) – ein VACUUM könnte Speicher freigeben.</div>
    {% else %}
      <div class="alert alert-ok"><i class="fas fa-check"></i> Freelist unauffällig ({{ free }})</div>
    {% endif %}

    <div class="panel">
      <h3><i class="fas fa-heartbeat"></i> Zusammenfassung</h3>
      <ul style="padding-left:18px;line-height:1.7">
        <li>Journal Mode: <strong>{{ db_stats.get('journal_mode','-') }}</strong></li>
        <li>Synchronous: <strong>{{ db_stats.get('synchronous','-') }}</strong></li>
        <li>Cache Size: <strong>{{ db_stats.get('cache_size','-') }}</strong></li>
        <li>Foreign Keys aktiv: <strong>{{ db_stats.get('foreign_keys','-') }}</strong></li>
      </ul>
    </div>
  </div>
</div>

<script>
  function showTab(ev, id){
    document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active'));
    document.querySelectorAll('.nav-tab').forEach(e=>e.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    ev.currentTarget.classList.add('active');
  }

  async function refreshStats(){
    const btn = document.querySelector('.btn-refresh');
    const txt = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Aktualisiere...';
    btn.disabled = true;
    try{
      const res = await fetch('/api/database-stats');
      if(res.ok){ location.reload(); }
      else{ alert('Fehler beim Aktualisieren'); }
    }catch(e){ alert('Netzwerkfehler: '+e.message); }
    finally{
      btn.innerHTML = txt;
      btn.disabled = false;
    }
  }

  // Optionales Auto-Refresh (sanft)
  setInterval(()=>{
    if(document.visibilityState==='visible'){
      fetch('/api/database-stats').catch(()=>{});
    }
  }, 30000);
</script>
</body>
</html>
